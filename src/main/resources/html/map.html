<!DOCTYPE html>
<html>

<head>
    <title>Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
    <link rel="stylesheet"
        href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
    <script
        src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script>
        let map;
        let lat = -43.5279;
        let lon = 172.5765;
        let markers = [];
        let coordinate;
        var javaScriptBridge; // must be declared as var (will not be correctly assigned in java with let keyword)
        let isRoute;
        let routeToCharger;
        let pointCoordinates = []; // contains a list of all the coordinates in a route in order.

        /**
         * Creates a star icon
         */
        let redIcon = L.icon({
            iconUrl: 'icons/red_icon.png',
            iconSize: [24, 24],
            iconAnchor: [12, 0],
        })

        /**
         * This object can be returned to our java code, where we can call the functions we define inside of it
         */
        let jsConnector = {
            addMarker: addMarker,
            addCoordinate: addCoordinate,
            movePosition: movePosition,
            addRoute: addRoute,
            removeRoute: removeRoute,
            initMap: initMap,
            clearMarkers: clearMarkers,
            addLocationToRoute: addLocationToRoute,
        };


        /**
         * Creates an object with the lat, lon, id and type attributes
         *
         * @param lat the latitude of the object
         * @param lon the longitude of the object
         * @param id the id of the object according to the database, or address of coordinate for now
         * @param type the type of object ("p" = coordinate, "c" = charger)
         * @constructor
         */
        function Location(lat, lon, id, type) {
            this.lat = lat;
            this.lon = lon;
            this.id = id;
            this.type = type;
        }


        /**
         * creates and initialises the Google map, also defines on click event that calls java code
         *
         */
        function initMap() {

            var mapOptions = {
                center: [lat, lon],
                zoom: 12
            }
            map = new L.map('map', mapOptions);
            new L.TileLayer('https://tile.csse.canterbury.ac.nz/hot/{z}/{x}/{y}.png', { // UCs tilemap server
                attribution: 'Â© OpenStreetMap contributors<br>Served by University of Canterbury'
            }).addTo(map)

            createBar().addTo(map)

            map.on("click", (map_event) => {
                var latlng = map.mouseEventToLatLng(map_event.originalEvent)
                if (!isRoute) {
                    javaScriptBridge.addCoordinateFromClick(`{"lat": ${latlng.lat}, "lng": ${latlng.lng}}`)
                    removeCoordinate()
                    new L.Control.Geocoder.Nominatim({
                        geocodingQueryParams: {
                            countrycodes: 'nz'
                        }}).reverse(latlng, map.options.crs.scale(map.getZoom()), results => {
                        var r = results[0]
                        if (r) {
                            addCoordinate(r.name, latlng.lat, latlng.lng)
                            javaScriptBridge.addLocationName(r.name)
                        } else {
                            addCoordinate("Selected Coordinate: ", latlng.lat, latlng.lng)
                        }
                    })
                    javaScriptBridge.refreshTable()
                }
            })
        }

        /**
         * Creates and sets a searchBar for basic geolocation needs and parsing
         */
        function createBar() {
            var searchBar = L.Control.geocoder({
                geocoder: new L.Control.Geocoder.Nominatim({
                    geocodingQueryParams: {
                        countrycodes: 'nz'
                    }}),
                defaultMarkGeocode: false,
                position: "topleft",
                collapsed: false,
                placeholder: "Search location",
            }).on('markgeocode', function(e) {
                var latlng = e.geocode.center
                javaScriptBridge.addCoordinateFromClick(`{"lat": ${latlng.lat}, "lng": ${latlng.lng}}`)
                removeCoordinate()
                addCoordinate(e.geocode.name, latlng.lat, latlng.lng)
                javaScriptBridge.addLocationName(e.geocode.name)
                javaScriptBridge.refreshTable()
            })
            return searchBar;
        }


        /**
         * Adds a charger marker to the map and stores it in the markers array for later use (e.g. removal)
         *
         * @param title tooltip to display on hover
         * @param lat latitude to place marker at
         * @param lng longitude to place marker at
         */
        function addMarker(title, lat, lng, id) {
            var m = new L.Marker([lat, lng])
            m.id = id
            m.bindPopup("Address: " + title + "<br><button type='button' onclick='javaScriptBridge.loadMoreInfo("+
                id + ")'>More Info</button>")
            m.on("mouseover", function(ev) {m.openPopup();})
            m.addTo(map).on("click", e => javaScriptBridge.chargerHandler(id),
            )
            markers.push(m)
        }

        /**
         * Clears the markers
         */
        function clearMarkers() {
            markers.forEach(function (item, index) {
                item.remove();
            });
            markers = [];
        }

        /**
         * Adds a coordinate to the map and stores it by itself
         * @param title tooltip to display on hover
         * @param lat latitude to place coordinate marker at
         * @param lng longitude to place coordinate marker at
         */
        function addCoordinate(title, lat, lng) {
            coordinate = new L.Marker([lat, lng])
            coordinate.bindPopup(title + ": " + lat.toFixed(4) + " " + lng.toFixed(4))
            coordinate.on("click", function(ev) {coordinate.openPopup()})
            coordinate.addTo(map)
            movePosition(lat, lng)
        }

        /**
         * Remove coordinate
         */
        function removeCoordinate() {
            if (coordinate) {
                coordinate.remove()
            }
        }

        /**
         * Moves position of centre of map
         */
        function movePosition(lat, lon) {
            map.panTo(new L.LatLng(lat, lon))
        }

        /**
         * Adds a location object to the route using an index to determine location.
         *
         * @param lat the latitude of the coordinate/charger
         * @param lon the longitude of the coordinate/charger
         * @param id the id of the coordinate/charger
         * @param type the type of object ("p" for coordinate, "c" for charger)
         * @param index the index of the object for the list.
         */
        function addLocationToRoute(lat, lon, id, type, index) {
            var location = new Location(lat, lon, id, type)
            pointCoordinates.splice(index, 0, location)
            refreshRoute()
        }

        /**
         * Refreshes the route to display all points
         */
        function refreshRoute() {
            if (routeToCharger) {
                routeToCharger.remove()
            }
            let coordinates = []
            for (i = 0; i < pointCoordinates.length; i++) {
                coordinates.push(new L.latLng(pointCoordinates[i].lat, pointCoordinates[i].lon))
            }
            routeToCharger = L.Routing.control({
                waypoints: coordinates,
                serviceUrl: 'https://tile.csse.canterbury.ac.nz/route/v1',
                routeWhileDragging: true,
                geocoder: new L.Control.Geocoder.Nominatim({
                    geocodingQueryParams: {
                        countrycodes: 'nz'
                    }}),
            }).addTo(map);
        }

        /**
         * Adds a selected route to charger onto the map with selected waypoints
         *
         */
        function addRoute() {
            isRoute = true
            refreshRoute()
        }


        /**
         * Removes all points on all routes and resets to default
         *
         */
        function removeRoute() {
            isRoute = false
            if (routeToCharger) {
                routeToCharger.remove()
                pointCoordinates = []
            }
        }

    </script>
</body>

</html>